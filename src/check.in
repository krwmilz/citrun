#!/bin/sh -e

function err {
	echo "${1}"
	exit 1
}

dir=`pwd`
[ $# -eq 1 ] && dir="${1}"
[ -d $dir ] || err "$dir: no such directory"

GREP[1]="citrun-inst"
GREP[2]="Forked "
GREP[3]="Instrumentation successful"
GREP[4]="And the native compile failed"
GREP[5]="But the native compile succeeded"
GREP[6]="Link detected"

DESC[0]="Log files found"
DESC[1]="Calls to the instrumentation tool"
DESC[2]="Forked compilers"
DESC[3]="Instrumentation successes"
DESC[4]="Instrumentation failures (false positive)"
DESC[5]="Instrumentation failures (true positive)"
DESC[6]="Application link commands"

for i in 0 1 2 3 4 5 6; do
	COUNT[$i]=0
done

echo -n Checking \'$dir\'
for d in `find $dir -name citrun.log`; do
	echo -n .
	COUNT[0]=`expr ${COUNT[0]} + 1`

	for i in 1 2 3 4 5 6; do
		tmp=`grep -c "${GREP[$i]}" $d`
		COUNT[$i]=`expr ${COUNT[$i]} + $tmp`
	done
done
echo

[ ${COUNT[0]} -eq 0 ] && err "No results."

for i in 0 1 2 3 4 5 6; do
	[ ${COUNT[$i]} -eq 0 ] && continue
	printf "%8i  %s\n" ${COUNT[$i]} "${DESC[$i]}"
done
