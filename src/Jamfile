SubDir TOP src ;

#
# citrun-wrap
#
rule MkWrap
{
	Depends $(1) : $(2) ;
	Depends exe : $(1) ;
	Clean clean : $(1) ;
}

actions MkWrap
{
	sed -e s,%CITRUN_PATH%,$(CITRUN_PATH), < $(2) > $(1) ;
	chmod 755 $(1) ;
}

LOCATE on citrun-wrap = $(LOCATE_TARGET) ;
SEARCH on wrap.in = $(SEARCH_SOURCE) ;
MkWrap citrun-wrap : wrap.in ;
InstallShell $(PREFIX)/bin : citrun-wrap ;

#
# citrun-gl
#
GL_SRCS =
	gl_main.cc
	gl_runtime_conn.cc
	af_unix.cc
	gl_view.cc
	demo-atlas.cc
	gl_buffer.cc
	demo-font.cc
	demo-glstate.cc
	demo-shader.cc
	matrix4x4.c
	trackball.c ;

ObjectC++Flags $(GL_SRCS) : -std=c++11 ;
ObjectC++Flags $(GL_SRCS) : `pkg-config $(PKG_CONFIG_LIBS) --cflags` ;

LINKLIBS on citrun-gl += `pkg-config $(PKG_CONFIG_LIBS) --libs` ;
LinkLibraries citrun-gl : libglyphy ;

Main citrun-gl : $(GL_SRCS) ;
InstallBin $(PREFIX)/bin : citrun-gl ;

#
# citrun-inst
#
INST_SRCS =
	inst_main.cc
	inst_action.cc
	inst_ast_visitor.cc ;

# Older llvm-config doesn't add -std=c++11
ObjectC++Flags $(INST_SRCS) : -std=c++11 `llvm-config --cxxflags` ;

LINKFLAGS on citrun-inst = `llvm-config --ldflags` ;
LLVM_LIBS = bitreader mcparser transformutils option ;
LINKLIBS on citrun-inst += `llvm-config --libs $(LLVM_LIBS) --system-libs` ;

Main citrun-inst : $(INST_SRCS) ;
InstallBin $(PREFIX)/share/citrun : citrun-inst ;

# Compiler symlinks
COMPILERS = cc gcc clang clang++ g++ c++ egcc eg++ ;
LOCATE on $(COMPILERS) = $(LOCATE_TARGET) ;

rule InstLink
{
	Depends files : $(<) ;
	Depends $(<) : $(>) ;
	Clean clean : $(<) ;
}

actions InstLink
{
	$(RM) $(<) && $(LN) -s citrun-inst $(<) ;
}

InstLink cc : citrun-inst ;
InstLink gcc : citrun-inst ;
InstLink clang : citrun-inst ;
InstLink clang++ : citrun-inst ;
InstLink g++ : citrun-inst ;
InstLink c++ : citrun-inst ;
InstLink egcc : citrun-inst ;
InstLink eg++ : citrun-inst ;

CP = cp -PR ;
FILEMODE = 755 ;
InstallFile $(PREFIX)/share/citrun : $(COMPILERS) ;

SubInclude TOP src glyphy ;
