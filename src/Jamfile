SubDir TOP src ;

rule MkCitrunWrap
{
	Depends $(1) : $(2) ;
	Depends all : $(1) ;
	Clean clean : $(1) ;
}

actions MkCitrunWrap
{
	sed -e s,%PREFIX%,$(PREFIX), < $(2) > $(1) ;
	chmod 755 $(1) ;
}

MkCitrunWrap $(TOP)/src/citrun-wrap : $(TOP)/src/wrap.in ;

INST_SRCS =
	inst_main.cc
	inst_action.cc
	inst_ast_visitor.cc ;

GL_SRCS =
	gl_main.cc
	gl_runtime_conn.cc
	af_unix.cc
	gl_view.cc
	demo-atlas.cc
	gl_buffer.cc
	demo-font.cc
	demo-glstate.cc
	demo-shader.cc
	matrix4x4.c
	trackball.c ;

ObjectC++Flags $(INST_SRCS) $(GL_SRCS) : -std=c++11 ;

ObjectC++Flags $(INST_SRCS) : `llvm-config --cxxflags` ;
ObjectC++Flags $(GL_SRCS) : `pkg-config $(PKG_CONFIG_LIBS) --cflags` ;
ObjectC++Flags $(GL_SRCS) : -I/usr/local/include ;

LINKFLAGS on citrun-inst = `llvm-config --ldflags` ;

LLVM_LIBS = bitreader mcparser transformutils option ;
LINKLIBS on citrun-inst += `llvm-config --libs $(LLVM_LIBS) --system-libs` ;
LINKLIBS on citrun-gl += `pkg-config $(PKG_CONFIG_LIBS) --libs` ;

LinkLibraries citrun-gl : libglyphy ;

Main citrun-inst : $(INST_SRCS) ;
Main citrun-gl : $(GL_SRCS) ;

InstallShell $(PREFIX)/bin : citrun-wrap ;
InstallBin $(PREFIX)/bin : citrun-inst citrun-gl ;

SubInclude TOP src glyphy ;
