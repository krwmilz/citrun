SubDir TOP src ;

#
# libcitrun.a and utils.a
#
ObjectCcFlags rt.c : -fPIC -ansi ;
Library libcitrun : rt.c ;

Library utils : process_file.cc process_dir.cc ;
LinkLibraries citrun-term citrun-gl : utils ;

#
# citrun-wrap, citrun-check
#
MakeLocate citrun-check citrun-wrap : $(LOCATE_SOURCE) ;
Shell citrun-check : check.sh ;
Shell citrun-wrap : wrap.sh ;

ReplaceTokens citrun-wrap ;

#
# citrun-term
#
LINKLIBS on citrun-term += -lcurses ;
# XXX: Not the main focus right now.
# Main citrun-term : term_main.cc ;

#
# citrun-gl
#
GL_SRCS =
	gl_main.cc
	gl_view.cc
	demo-atlas.cc
	gl_buffer.cc
	demo-font.cc
	demo-glstate.cc
	demo-shader.cc
	matrix4x4.c
	trackball.c ;

Stringize demo_atlas_glsl.h :   demo_atlas.glsl ;
Stringize demo_vshader_glsl.h : demo_vshader.glsl ;
Stringize demo_fshader_glsl.h : demo_fshader.glsl ;

ObjectC++Flags $(GL_SRCS) : `pkg-config $(PKG_CONFIG_LIBS) --cflags` ;
# Bug in openbsd pkg-config, fixed in -current.
ObjectC++Flags $(GL_SRCS) : -I/usr/local/include ;

LINKLIBS on citrun-gl += `pkg-config $(PKG_CONFIG_LIBS) --libs` ;
LinkLibraries citrun-gl : libglyphy ;

Main citrun-gl : $(GL_SRCS) ;

#
# citrun-inst
#
INST_SRCS =
	inst_main.cc
	inst_frontend.cc
	inst_action.cc
	inst_visitor.cc ;

Stringize rt_h.h : rt.h ;

ObjectC++Flags $(INST_SRCS) : `llvm-config --cxxflags` ;
ObjectDefines $(INST_SRCS) : CITRUN_SHARE=\\\"$(CITRUN_SHARE)\\\" ;

LINKFLAGS on citrun-inst = $(LINKFLAGS) `llvm-config --ldflags` ;

LLVM_LIBS = bitreader mcparser transformutils option ;
LINKLIBS on citrun-inst += `llvm-config --libs $(LLVM_LIBS) --system-libs` ;

Main citrun-inst : $(INST_SRCS) ;

#
# install
#
InstallLib	$(PREFIX)/share/citrun	: libcitrun.a ;
InstallShell	$(PREFIX)/bin		: citrun-wrap citrun-check ;
InstallBin	$(PREFIX)/bin		: citrun-gl citrun-inst ;
InstallSyms	$(PREFIX)/share/citrun	: cc gcc clang clang++ g++ c++ egcc eg++ ;

SubInclude TOP src glyphy ;
