#OPTIM = -O2 ;

# This should be set by the packaging system so that we can make binaries that
# will find everything they need to.
# If not, it will build binaries pointing to in-tree versions of everything.
PREFIX ?= `pwd`/$(TOP) ;

if $(OS) = OPENBSD {
	C++ = eg++ ;
	SHLIB_SUF = so.0.0 ;

	CLANG_INCL = "-I/usr/local/lib/clang/3.7.1/include" ;
	C++FLAGS = -DLLVM_VER=34 ;

	PKG_CONFIG_LIBS = gl glew freetype2 ;
	# Link directly against libestdc++ from ports
	LINKLIBS on citrun_gl = -lestdc++ -lm -lglut ;

	LINKLIBS on citrun_instrument =
		-lestdc++
		-Wl,--start-group
		-lclangAST
		-lclangAnalysis
		-lclangBasic
		-lclangDriver
		-lclangEdit
		-lclangFrontend
		-lclangFrontendTool
		-lclangLex
		-lclangParse
		-lclangRewriteCore
		-lclangRewriteFrontend
		-lclangSema
		-lclangSerialization
		-lclangTooling
		-Wl,--end-group ;
}

if $(OS) = MACOSX {
	SHLIB_SUF = dylib ;

	CLANG_INCL = "-I/opt/local/libexec/llvm-3.7/lib/clang/3.7/include" ;
	C++FLAGS = -Wno-deprecated -DLLVM_VER=37 ;

	PKG_CONFIG_LIBS = glew freetype2 ;
	LINKLIBS on citrun_gl = -framework OpenGL -framework GLUT ;
	LINKLIBS on citrun_gl += -lc++ -lm ;

	# We must specify that the entry point will be available at runtime
	LINKFLAGS on libcitrun.$(SHLIB_SUF) = -Wl,-U,__citrun_tu_head ;

	LINKLIBS on citrun_instrument =
		-lc++
		-lclangAST
		-lclangAnalysis
		-lclangBasic
		-lclangDriver
		-lclangEdit
		-lclangFrontend
		-lclangFrontendTool
		-lclangLex
		-lclangParse
		-lclangRewrite
		-lclangRewriteFrontend
		-lclangSema
		-lclangSerialization
		-lclangTooling ;
}

if $(OS) = LINUX {
	SHLIB_SUF = so ;

	C++FLAGS = -DLLVM_VER=35 ;

	PKG_CONFIG_LIBS = gl glew freetype2 ;
	# Link directly against libestdc++ from ports
	LINKLIBS on citrun_gl = -lstdc++ -lm -lglut ;

	LINKLIBS on citrun_instrument =
		-Wl,--start-group
		-lclangAST
		-lclangAnalysis
		-lclangBasic
		-lclangDriver
		-lclangEdit
		-lclangFrontend
		-lclangFrontendTool
		-lclangLex
		-lclangParse
		-lclangRewrite
		-lclangRewriteFrontend
		-lclangSema
		-lclangSerialization
		-lclangTooling
		-Wl,--end-group
		-lstdc++
		-lbsd ;
}

# We have to set this down here because LIBCITRUN_PATH and CLANG_INCL depend on
# operating system specific locations and names.
LIBCITRUN_PATH = $(PREFIX)/lib/libcitrun.$(SHLIB_SUF) ;
C++FLAGS += -DLIBCITRUN_PATH=$(LIBCITRUN_PATH) -DCLANG_INCL=$(CLANG_INCL) ;
