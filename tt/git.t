use strict;
use warnings;
use Expect;
use Test::More tests => 540 ;
use test::package;
use test::viewer;
use Time::HiRes qw( usleep );

my $package = test::package->new("devel/git");
my $viewer = test::viewer->new();

my $exp = Expect->spawn("/usr/ports/pobj/git-2.9.0/git-2.9.0/git", "clone", "http://git.0x30.net/citrun", "/usr/ports/pobj/git-*");
$viewer->accept();
$viewer->cmp_static_data([
		["/abspath.c",181,228],
		["/advice.c",120,196],
		["/alias.c",78,189],
		["/alloc.c",116,191],
		["/archive-tar.c",454,349],
		["/archive-zip.c",586,349],
		["/archive.c",561,368],
		["/argv-array.c",88,191],
		["/attr.c",826,388],
		["/base85.c",133,181],
		["/bisect.c",1033,520],
		["/blob.c",19,177],
		["/branch.c",372,353],
		["/builtin/add.c",444,397],
		["/builtin/am.c",2429,1225],
		["/builtin/annotate.c",23,179],
		["/builtin/apply.c",4666,1724],
		["/builtin/archive.c",110,229],
		["/builtin/bisect--helper.c",32,179],
		["/builtin/blame.c",2884,1035],
		["/builtin/branch.c",876,621],
		["/builtin/bundle.c",74,219],
		["/builtin/cat-file.c",541,383],
		["/builtin/check-attr.c",187,242],
		["/builtin/check-ignore.c",188,262],
		["/builtin/check-mailmap.c",67,200],
		["/builtin/check-ref-format.c",89,215],
		["/builtin/checkout-index.c",258,294],
		["/builtin/checkout.c",1286,731],
		["/builtin/clean.c",1001,545],
		["/builtin/clone.c",1114,726],
		["/builtin/column.c",60,197],
		["/builtin/commit-tree.c",130,247],
		["/builtin/commit.c",1830,1137],
		["/builtin/config.c",723,502],
		["/builtin/count-objects.c",158,237],
		["/builtin/credential.c",32,191],
		["/builtin/describe.c",483,429],
		["/builtin/diff-files.c",72,215],
		["/builtin/diff-index.c",58,212],
		["/builtin/diff-tree.c",189,265],
		["/builtin/diff.c",474,395],
		["/builtin/fast-export.c",1074,585],
		["/builtin/fetch-pack.c",222,260],
		["/builtin/fetch.c",1243,691],
		["/builtin/fmt-merge-msg.c",715,483],
		["/builtin/for-each-ref.c",82,195],
		["/builtin/fsck.c",695,454],
		["/builtin/gc.c",446,405],
		["/builtin/get-tar-commit-id.c",42,188],
		["/builtin/grep.c",928,503],
		["/builtin/hash-object.c",156,225],
		["/builtin/help.c",501,413],
		["/builtin/index-pack.c",1793,915],
		["/builtin/init-db.c",580,467],
		["/builtin/interpret-trailers.c",50,184],
		["/builtin/log.c",1893,965],
		["/builtin/ls-files.c",568,346],
		["/builtin/ls-remote.c",115,217],
		["/builtin/ls-tree.c",190,240],
		["/builtin/mailinfo.c",62,205],
		["/builtin/mailsplit.c",342,301],
		["/builtin/merge-base.c",260,299],
		["/builtin/merge-file.c",112,214],
		["/builtin/merge-index.c",111,213],
		["/builtin/merge-ours.c",35,181],
		["/builtin/merge-recursive.c",81,214],
		["/builtin/merge-tree.c",380,304],
		["/builtin/merge.c",1640,982],
		["/builtin/mktag.c",175,230],
		["/builtin/mktree.c",192,232],
		["/builtin/mv.c",287,348],
		["/builtin/name-rev.c",414,311],
		["/builtin/notes.c",1022,628],
		["/builtin/pack-objects.c",2780,1114],
		["/builtin/pack-redundant.c",696,395],
		["/builtin/pack-refs.c",22,181],
		["/builtin/patch-id.c",199,252],
		["/builtin/prune-packed.c",68,196],
		["/builtin/prune.c",158,266],
		["/builtin/pull.c",929,622],
		["/builtin/push.c",572,384],
		["/builtin/read-tree.c",250,288],
		["/builtin/receive-pack.c",1793,916],
		["/builtin/reflog.c",751,522],
		["/builtin/remote-ext.c",200,240],
		["/builtin/remote-fd.c",80,203],
		["/builtin/remote.c",1634,909],
		["/builtin/repack.c",415,363],
		["/builtin/replace.c",500,398],
		["/builtin/rerere.c",117,253],
		["/builtin/reset.c",390,391],
		["/builtin/rev-list.c",404,353],
		["/builtin/rev-parse.c",877,600],
		["/builtin/revert.c",215,254],
		["/builtin/rm.c",435,374],
		["/builtin/send-pack.c",301,250],
		["/builtin/shortlog.c",342,319],
		["/builtin/show-branch.c",952,510],
		["/builtin/show-ref.c",229,265],
		["/builtin/stripspace.c",62,191],
		["/builtin/submodule--helper.c",875,537],
		["/builtin/symbolic-ref.c",77,209],
		["/builtin/tag.c",498,430],
		["/builtin/unpack-file.c",37,195],
		["/builtin/unpack-objects.c",581,404],
		["/builtin/update-index.c",1166,634],
		["/builtin/update-ref.c",444,351],
		["/builtin/update-server-info.c",26,180],
		["/builtin/upload-archive.c",128,224],
		["/builtin/var.c",94,208],
		["/builtin/verify-commit.c",95,203],
		["/builtin/verify-pack.c",83,197],
		["/builtin/verify-tag.c",59,190],
		["/builtin/worktree.c",478,441],
		["/builtin/write-tree.c",57,188],
		["/bulk-checkin.c",278,258],
		["/bundle.c",494,416],
		["/cache-tree.c",724,441],
		["/color.c",396,302],
		["/column.c",416,302],
		["/combine-diff.c",1544,651],
		["/commit.c",1697,793],
		["/compat/obstack.c",414,114],
		["/compat/terminal.c",148,108],
		["/config.c",2452,1240],
		["/connect.c",834,480],
		["/connected.c",117,205],
		["/convert.c",1414,615],
		["/copy.c",68,208],
		["/credential.c",374,345],
		["/csum-file.c",187,237],
		["/ctype.c",67,80],
		["/date.c",1189,533],
		["/decorate.c",86,191],
		["/diff-delta.c",490,153],
		["/diff-lib.c",536,345],
		["/diff-no-index.c",304,309],
		["/diff.c",5157,2177],
		["/diffcore-break.c",305,252],
		["/diffcore-delta.c",236,238],
		["/diffcore-order.c",132,222],
		["/diffcore-pickaxe.c",239,254],
		["/diffcore-rename.c",680,373],
		["/dir.c",2708,999],
		["/editor.c",69,203],
		["/entry.c",293,298],
		["/environment.c",348,279],
		["/ewah/bitmap.c",214,219],
		["/ewah/ewah_bitmap.c",711,322],
		["/ewah/ewah_io.c",210,172],
		["/ewah/ewah_rlw.c",116,121],
		["/exec_cmd.c",154,211],
		["/fetch-pack.c",1062,668],
		["/fsck.c",830,538],
		["/gettext.c",180,143],
		["/git.c",719,434],
		["/gpg-interface.c",261,264],
		["/graph.c",1332,440],
		["/grep.c",1798,828],
		["/hashmap.c",266,235],
		["/help.c",474,352],
		["/hex.c",91,185],
		["/ident.c",518,353],
		["/kwset.c",772,309],
		["/levenshtein.c",87,181],
		["/line-log.c",1254,551],
		["/line-range.c",291,218],
		["/list-objects.c",235,263],
		["/ll-merge.c",413,290],
		["/lockfile.c",208,265],
		["/log-tree.c",888,531],
		["/mailinfo.c",1038,583],
		["/mailmap.c",365,295],
		["/match-trees.c",345,280],
		["/merge-blobs.c",93,198],
		["/merge-recursive.c",2109,957],
		["/merge.c",97,260],
		["/mergesort.c",74,195],
		["/name-hash.c",239,243],
		["/notes-cache.c",96,219],
		["/notes-merge.c",752,516],
		["/notes-utils.c",177,272],
		["/notes.c",1319,581],
		["/object.c",428,315],
		["/pack-bitmap-write.c",549,349],
		["/pack-bitmap.c",1069,519],
		["/pack-check.c",182,225],
		["/pack-objects.c",110,201],
		["/pack-revindex.c",201,193],
		["/pack-write.c",372,286],
		["/pager.c",179,237],
		["/parse-options-cb.c",223,250],
		["/parse-options.c",677,451],
		["/patch-delta.c",87,108],
		["/patch-ids.c",106,221],
		["/path.c",1249,568],
		["/pathspec.c",497,333],
		["/pkt-line.c",251,256],
		["/preload-index.c",114,211],
		["/pretty.c",1818,864],
		["/prio-queue.c",91,194],
		["/progress.c",268,184],
		["/prompt.c",76,196],
		["/quote.c",456,297],
		["/reachable.c",207,259],
		["/read-cache.c",2327,957],
		["/ref-filter.c",1713,871],
		["/reflog-walk.c",339,291],
		["/refs.c",1232,676],
		["/refs/files-backend.c",3433,1323],
		["/remote.c",2367,1172],
		["/replace_object.c",123,211],
		["/rerere.c",1252,663],
		["/resolve-undo.c",193,242],
		["/revision.c",3316,1457],
		["/run-command.c",1197,578],
		["/send-pack.c",582,419],
		["/sequencer.c",1163,809],
		["/server-info.c",286,292],
		["/setup.c",1059,647],
		["/sha1-array.c",60,185],
		["/sha1-lookup.c",318,228],
		["/sha1_file.c",3647,1492],
		["/sha1_name.c",1515,777],
		["/shallow.c",665,471],
		["/sideband.c",153,205],
		["/sigchain.c",62,193],
		["/split-index.c",322,256],
		["/strbuf.c",866,457],
		["/streaming.c",554,302],
		["/string-list.c",311,273],
		["/submodule-config.c",508,361],
		["/submodule.c",1164,689],
		["/symlinks.c",324,222],
		["/tag.c",196,263],
		["/tempfile.c",306,282],
		["/thread-utils.c",78,183],
		["/trace.c",435,277],
		["/trailer.c",916,573],
		["/transport-helper.c",1388,753],
		["/transport.c",1119,590],
		["/tree-diff.c",708,306],
		["/tree-walk.c",1063,481],
		["/tree.c",254,263],
		["/unpack-trees.c",1961,832],
		["/url.c",132,214],
		["/urlmatch.c",539,339],
		["/usage.c",191,209],
		["/userdiff.c",290,241],
		["/utf8.c",668,294],
		["/varint.c",31,88],
		["/version.c",39,117],
		["/versioncmp.c",144,194],
		["/wildmatch.c",280,225],
		["/worktree.c",306,328],
		["/wrapper.c",699,428],
		["/write_or_die.c",108,212],
		["/ws.c",396,298],
		["/wt-status.c",1756,1057],
		["/xdiff-interface.c",323,279],
		["/xdiff/xdiffi.c",645,166],
		["/xdiff/xemit.c",268,100],
		["/xdiff/xhistogram.c",364,97],
		["/xdiff/xmerge.c",687,233],
		["/xdiff/xpatience.c",359,95],
		["/xdiff/xprepare.c",484,138],
		["/xdiff/xutils.c",496,127],
		["/zlib.c",274,241],
]);

$viewer->cmp_dynamic_data();

$exp->hard_close();
$viewer->close();

open( my $fh, ">", "check.good" );
print $fh <<EOF;
Checking ..done

Summary:
         1 Log files found
       381 Source files input
       448 Calls to the instrumentation tool
       381 Forked compilers
       376 Instrument successes
         5 Both instrument and native compile failed (FP)
        82 Application link commands
        45 Warnings during source parsing
         5 Errors during source parsing

Totals:
    185689 Lines of source code
     12192 Lines of instrumentation header
       100 Functions called 'main'
      6015 Function definitions
     16473 If statements
      1497 For loops
      1025 While loops
        71 Do while loops
       272 Switch statements
      6825 Return statement values
     30619 Call expressions
    528856 Total statements
      1530 Errors rewriting source
EOF

system("$ENV{CITRUN_TOOLS}/citrun-check /usr/ports/pobj/git-* > check.out");
system("diff -u check.good check.out");
$package->clean();
