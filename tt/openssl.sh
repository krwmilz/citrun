#
# Instrument openssl, run its testsuite, check the logs and do a quick runtime
# sanity test on it.
#
echo 1..8

. test/package.sh "security/openssl"

pkg_check_deps 2
pkg_clean 3
pkg_build 4

cat <<EOF > check.good
Summary:
       868 Calls to the rewrite tool
       752 Source files used as input
        58 Application link commands
       752 Rewrite parse warnings
       752 Rewrite successes
       752 Rewritten source compile successes

Totals:
    322027 Lines of source code
      6722 Function definitions
     15969 If statements
       877 For loops
       277 While loops
        47 Do while loops
       275 Switch statements
      7438 Return statement values
     18751 Call expressions
    418826 Total statements
     27553 Binary operators
      2912 Errors rewriting source
EOF
pkg_check 5

LD_LIBRARY_PATH="$TEST_WRKDIST" \
	$TEST_WRKDIST/apps/openssl genrsa -out KEY 16384 &
pid=$!

sleep 3

$CITRUN_TOOLS/citrun-dump

test_total_execs 6

cat <<EOF >filelist.good
a_bitstr.c 263
a_bool.c 112
a_bytes.c 307
a_d2i_fp.c 285
a_digest.c 112
a_dup.c 118
a_enum.c 182
a_gentm.c 313
a_i2d_fp.c 158
a_int.c 465
a_mbstr.c 424
a_object.c 403
a_octet.c 79
a_print.c 130
a_set.c 239
a_sign.c 332
a_strex.c 650
a_strnid.c 314
a_time.c 229
a_type.c 156
a_utctm.c 353
a_utf8.c 238
a_verify.c 232
aes_cfb.c 86
aes_ctr.c 64
aes_ecb.c 74
aes_ige.c 324
aes_misc.c 87
aes_ofb.c 62
aes_wrap.c 73
ameth_lib.c 485
app_rand.c 218
apps.c 3229
asm/x86_64-gcc.c 639
asn1_err.c 355
asn1_gen.c 832
asn1_lib.c 480
asn1_par.c 425
asn1pars.c 431
asn_mime.c 975
asn_moid.c 154
asn_pack.c 208
b_dump.c 209
b_print.c 864
b_sock.c 963
bf_buff.c 518
bf_cfb64.c 124
bf_ecb.c 101
bf_enc.c 301
bf_nbio.c 254
bf_null.c 190
bf_ofb64.c 111
bf_skey.c 126
bio_asn1.c 483
bio_b64.c 574
bio_cb.c 146
bio_enc.c 429
bio_err.c 158
bio_lib.c 597
bio_md.c 273
bio_ndef.c 249
bio_ok.c 625
bio_pk7.c 71
bio_ssl.c 592
bn_add.c 314
bn_blind.c 386
bn_const.c 548
bn_ctx.c 449
bn_depr.c 116
bn_div.c 478
bn_err.c 155
bn_exp.c 1458
bn_exp2.c 304
bn_gcd.c 703
bn_gf2m.c 1301
bn_kron.c 187
bn_lib.c 917
bn_mod.c 317
bn_mont.c 559
bn_mpi.c 129
bn_mul.c 1165
bn_nist.c 1263
bn_prime.c 516
bn_print.c 398
bn_rand.c 296
bn_recp.c 253
bn_shift.c 225
bn_sqr.c 291
bn_sqrt.c 410
bn_word.c 228
bn_x931p.c 278
bss_acpt.c 464
bss_bio.c 887
bss_conn.c 613
bss_dgram.c 2082
bss_fd.c 331
bss_file.c 473
bss_log.c 454
bss_mem.c 314
bss_null.c 150
bss_sock.c 288
buf_err.c 98
buf_str.c 138
buffer.c 188
by_dir.c 437
by_file.c 278
c_all.c 91
c_allc.c 242
c_alld.c 115
c_cfb64.c 124
c_ecb.c 84
c_enc.c 201
c_ofb64.c 111
c_rle.c 63
c_skey.c 176
c_zlib.c 764
ca.c 2921
cbc128.c 208
cbc_cksm.c 104
cbc_enc.c 62
ccm128.c 480
cfb128.c 255
cfb64ede.c 250
cfb64enc.c 123
cfb_enc.c 200
ciphers.c 240
cm_ameth.c 97
cm_pmeth.c 217
cmac.c 307
cmll_cfb.c 142
cmll_ctr.c 65
cmll_ecb.c 74
cmll_misc.c 81
cmll_ofb.c 123
cmll_utl.c 65
cms.c 1358
cms_asn1.c 460
cms_att.c 198
cms_cd.c 135
cms_dd.c 146
cms_enc.c 261
cms_env.c 975
cms_err.c 310
cms_ess.c 396
cms_io.c 134
cms_kari.c 466
cms_lib.c 653
cms_pwri.c 436
cms_sd.c 958
cms_smime.c 837
comp_err.c 99
comp_lib.c 67
conf_api.c 306
conf_def.c 707
conf_err.c 134
conf_lib.c 392
conf_mall.c 82
conf_mod.c 598
conf_sap.c 100
cpt_err.c 105
crl.c 443
crl2p7.c 335
cryptlib.c 1031
ctr128.c 264
cts128.c 545
cversion.c 108
d1_both.c 1581
d1_clnt.c 870
d1_lib.c 574
d1_meth.c 91
d1_pkt.c 1922
d1_srtp.c 449
d1_srvr.c 981
d2i_pr.c 176
d2i_pu.c 137
des_enc.c 390
des_old.c 346
des_old2.c 81
dgst.c 615
dh.c 338
dh_ameth.c 958
dh_asn1.c 190
dh_check.c 188
dh_depr.c 83
dh_err.c 127
dh_gen.c 205
dh_kdf.c 188
dh_key.c 290
dh_lib.c 264
dh_pmeth.c 552
dh_prn.c 80
dh_rfc5114.c 286
dhparam.c 547
digest.c 409
dsa.c 375
dsa_ameth.c 679
dsa_asn1.c 203
dsa_depr.c 114
dsa_err.c 134
dsa_gen.c 749
dsa_key.c 146
dsa_lib.c 330
dsa_ossl.c 423
dsa_pmeth.c 313
dsa_prn.c 120
dsa_sign.c 111
dsa_vrf.c 76
dsaparam.c 470
dso_beos.c 254
dso_dl.c 381
dso_dlfcn.c 466
dso_err.c 159
dso_lib.c 449
dso_null.c 93
dso_openssl.c 84
dso_vms.c 548
dso_win32.c 789
e_aes.c 2025
e_aes_cbc_hmac_sha1.c 1009
e_aes_cbc_hmac_sha256.c 986
e_bf.c 88
e_camellia.c 395
e_cast.c 90
e_des.c 270
e_des3.c 496
e_idea.c 120
e_null.c 101
e_old.c 165
e_rc2.c 236
e_rc4.c 134
e_rc4_hmac_md5.c 309
e_rc5.c 123
e_seed.c 83
e_xcbc_d.c 131
ebcdic.c 285
ec.c 366
ec2_mult.c 464
ec2_oct.c 404
ec2_smpl.c 799
ec_ameth.c 966
ec_asn1.c 1327
ec_check.c 121
ec_curve.c 3249
ec_cvt.c 181
ec_err.c 333
ec_key.c 566
ec_lib.c 1135
ec_mult.c 914
ec_oct.c 193
ec_pmeth.c 531
ec_print.c 180
ecb3_enc.c 83
ecb_enc.c 125
ech_err.c 99
ech_kdf.c 112
ech_key.c 82
ech_lib.c 266
ech_ossl.c 219
eck_prn.c 378
ecp_mont.c 309
ecp_nist.c 221
ecp_nistp224.c 1770
ecp_nistp256.c 2370
ecp_nistp521.c 2149
ecp_nistputil.c 219
ecp_nistz256.c 1522
ecp_oct.c 429
ecp_smpl.c 1419
ecparam.c 662
ecs_asn1.c 68
ecs_err.c 108
ecs_lib.c 355
ecs_ossl.c 465
ecs_sign.c 107
ecs_vrf.c 113
ede_cbcm_enc.c 190
enc.c 716
enc_read.c 236
enc_writ.c 183
encode.c 461
eng_all.c 137
eng_cnf.c 243
eng_cryptodev.c 1536
eng_ctrl.c 386
eng_dyn.c 571
eng_err.c 182
eng_fat.c 182
eng_init.c 158
eng_lib.c 348
eng_list.c 406
eng_openssl.c 403
eng_pkey.c 187
eng_rdrand.c 150
eng_table.c 359
engine.c 513
err.c 1146
err_all.c 169
err_prn.c 114
errstr.c 122
evp_acnf.c 74
evp_asn1.c 196
evp_cnf.c 119
evp_enc.c 667
evp_err.c 255
evp_key.c 196
evp_lib.c 392
evp_pbe.c 313
evp_pkey.c 230
ex_data.c 647
f_enum.c 204
f_int.c 216
f_string.c 210
fcrypt.c 168
fcrypt_b.c 141
fips_ers.c 8
gcm128.c 2372
gendh.c 249
gendsa.c 288
genpkey.c 406
genrsa.c 351
hm_ameth.c 168
hm_pmeth.c 263
hmac.c 269
i2d_pr.c 79
i2d_pu.c 94
i_cbc.c 172
i_cfb64.c 124
i_ecb.c 89
i_ofb64.c 111
i_skey.c 172
krb5_asn.c 163
kssl.c 2261
lh_stats.c 247
lhash.c 459
m_dss.c 105
m_dss1.c 106
m_ecdsa.c 155
m_md2.c 107
m_md4.c 109
m_md5.c 108
m_mdc2.c 109
m_null.c 99
m_ripemd.c 108
m_sha.c 107
m_sha1.c 236
m_sigver.c 204
m_wp.c 49
md4_dgst.c 200
md4_one.c 97
md5_dgst.c 217
md5_one.c 97
md_rand.c 593
mdc2_one.c 77
mdc2dgst.c 197
mem.c 467
mem_dbg.c 831
n_pkey.c 346
names.c 216
nseq.c 171
nsseq.c 85
o_dir.c 87
o_fips.c 97
o_init.c 84
o_names.c 367
o_str.c 117
o_time.c 441
obj_dat.c 802
obj_err.c 101
obj_lib.c 136
obj_xref.c 223
ocsp.c 1368
ocsp_asn.c 184
ocsp_cl.c 384
ocsp_err.c 150
ocsp_ext.c 567
ocsp_ht.c 556
ocsp_lib.c 285
ocsp_prn.c 300
ocsp_srv.c 272
ocsp_vfy.c 455
ofb128.c 125
ofb64ede.c 124
ofb64enc.c 110
ofb_enc.c 132
openssl.c 697
p12_add.c 259
p12_asn.c 126
p12_attr.c 148
p12_crpt.c 120
p12_crt.c 359
p12_decr.c 203
p12_init.c 93
p12_key.c 239
p12_kiss.c 300
p12_mutl.c 196
p12_npas.c 236
p12_p8d.c 71
p12_p8e.c 106
p12_utl.c 162
p5_crpt.c 150
p5_crpt2.c 335
p5_pbe.c 144
p5_pbev2.c 281
p8_pkey.c 146
p_dec.c 88
p_enc.c 88
p_lib.c 457
p_open.c 130
p_seal.c 122
p_sign.c 134
p_verify.c 117
passwd.c 495
pcbc_enc.c 116
pcy_cache.c 270
pcy_data.c 130
pcy_lib.c 168
pcy_map.c 131
pcy_node.c 191
pcy_tree.c 832
pem_all.c 428
pem_err.c 169
pem_info.c 395
pem_lib.c 866
pem_oth.c 87
pem_pk8.c 260
pem_pkey.c 294
pem_seal.c 192
pem_sign.c 102
pem_x509.c 69
pem_xaux.c 71
pk12err.c 150
pk7_asn1.c 252
pk7_attr.c 166
pk7_doit.c 1296
pk7_lib.c 647
pk7_mime.c 97
pk7_smime.c 591
pkcs12.c 1059
pkcs7.c 313
pkcs7err.c 208
pkcs8.c 403
pkey.c 252
pkeyparam.c 186
pkeyutl.c 556
pmeth_fn.c 347
pmeth_gn.c 221
pmeth_lib.c 614
pqueue.c 236
prime.c 152
pvkfmt.c 889
qud_cksm.c 144
rand.c 230
rand_egd.c 293
rand_err.c 101
rand_key.c 68
rand_lib.c 301
rand_nw.c 180
rand_os2.c 171
rand_unix.c 448
rand_win.c 753
randfile.c 338
rc2_cbc.c 229
rc2_ecb.c 93
rc2_skey.c 158
rc2cfb64.c 124
rc2ofb64.c 111
rc4_utl.c 63
read2pwd.c 141
req.c 1733
rmd_dgst.c 335
rmd_one.c 78
rpc_enc.c 101
rsa.c 440
rsa_ameth.c 960
rsa_asn1.c 132
rsa_chk.c 215
rsa_crpt.c 248
rsa_depr.c 108
rsa_eay.c 905
rsa_err.c 248
rsa_gen.c 251
rsa_lib.c 337
rsa_none.c 95
rsa_null.c 156
rsa_oaep.c 284
rsa_pk1.c 276
rsa_pmeth.c 785
rsa_prn.c 93
rsa_pss.c 291
rsa_saos.c 149
rsa_sign.c 302
rsa_ssl.c 150
rsa_x931.c 168
rsautl.c 376
rsaz_exp.c 347
s23_clnt.c 803
s23_lib.c 186
s23_meth.c 90
s23_pkt.c 114
s23_srvr.c 653
s2_clnt.c 1095
s2_enc.c 198
s2_lib.c 571
s2_meth.c 92
s2_pkt.c 726
s2_srvr.c 1172
s3_both.c 748
s3_cbc.c 821
s3_clnt.c 3764
s3_enc.c 971
s3_lib.c 4537
s3_meth.c 75
s3_pkt.c 1749
s3_srvr.c 3615
s_cb.c 1658
s_client.c 2334
s_server.c 3506
s_socket.c 614
s_time.c 642
seed.c 712
seed_cbc.c 66
seed_cfb.c 119
seed_ecb.c 62
seed_ofb.c 118
sess_id.c 301
set_key.c 448
sha1_one.c 80
sha1dgst.c 75
sha256.c 388
sha512.c 685
sha_dgst.c 75
sha_one.c 80
smime.c 779
speed.c 2875
spkac.c 313
srp.c 769
srp_lib.c 358
srp_vfy.c 706
ssl_algs.c 156
ssl_asn1.c 637
ssl_cert.c 1265
ssl_ciph.c 2078
ssl_conf.c 692
ssl_err.c 838
ssl_err2.c 70
ssl_lib.c 3572
ssl_rsa.c 1044
ssl_sess.c 1274
ssl_stat.c 1079
ssl_txt.c 263
ssl_utst.c 73
stack.c 385
str2key.c 165
t1_clnt.c 91
t1_enc.c 1378
t1_ext.c 299
t1_lib.c 4440
t1_meth.c 85
t1_reneg.c 293
t1_srvr.c 93
t1_trce.c 1267
t_bitst.c 106
t_crl.c 134
t_pkey.c 114
t_req.c 255
t_spki.c 109
t_x509.c 557
t_x509a.c 116
tasn_dec.c 1228
tasn_enc.c 660
tasn_fre.c 250
tasn_new.c 382
tasn_prn.c 586
tasn_typ.c 150
tasn_utl.c 276
tb_asnmth.c 247
tb_cipher.c 144
tb_dh.c 125
tb_digest.c 144
tb_dsa.c 125
tb_ecdh.c 140
tb_ecdsa.c 125
tb_pkmeth.c 167
tb_rand.c 125
tb_rsa.c 125
tb_store.c 130
tls_srp.c 543
ts.c 1120
ts_asn1.c 327
ts_conf.c 492
ts_err.c 189
ts_lib.c 144
ts_req_print.c 105
ts_req_utils.c 233
ts_rsp_print.c 282
ts_rsp_sign.c 1021
ts_rsp_utils.c 397
ts_rsp_verify.c 738
ts_verify_ctx.c 163
txt_db.c 382
ui_compat.c 70
ui_err.c 112
ui_lib.c 871
ui_openssl.c 718
ui_util.c 94
uid.c 89
v3_addr.c 1345
v3_akey.c 206
v3_akeya.c 74
v3_alt.c 610
v3_asid.c 897
v3_bcons.c 133
v3_bitst.c 143
v3_conf.c 533
v3_cpols.c 492
v3_crld.c 563
v3_enum.c 101
v3_extku.c 150
v3_genn.c 251
v3_ia5.c 120
v3_info.c 211
v3_int.c 93
v3_lib.c 364
v3_ncons.c 480
v3_ocsp.c 313
v3_pci.c 318
v3_pcia.c 57
v3_pcons.c 140
v3_pku.c 115
v3_pmaps.c 157
v3_prn.c 260
v3_purp.c 853
v3_scts.c 335
v3_skey.c 151
v3_sxnet.c 274
v3_utl.c 1352
v3err.c 250
verify.c 353
version.c 215
wp_dgst.c 258
wrap128.c 139
x509.c 1276
x509_att.c 385
x509_cmp.c 499
x509_d2.c 110
x509_def.c 93
x509_err.c 188
x509_ext.c 212
x509_lu.c 711
x509_obj.c 231
x509_r2x.c 114
x509_req.c 329
x509_set.c 153
x509_trs.c 319
x509_txt.c 212
x509_v3.c 285
x509_vfy.c 2498
x509_vpm.c 663
x509cset.c 168
x509name.c 398
x509rset.c 86
x509spki.c 124
x509type.c 128
x_algor.c 149
x_all.c 559
x_attrib.c 125
x_bignum.c 154
x_crl.c 518
x_exten.c 78
x_info.c 118
x_long.c 197
x_name.c 539
x_nx509.c 73
x_pkey.c 154
x_pubkey.c 375
x_req.c 117
x_sig.c 70
x_spki.c 83
x_val.c 70
x_x509.c 240
x_x509a.c 197
xcbc_enc.c 217
xts128.c 205
EOF
$CITRUN_TOOLS/citrun-dump -f > filelist.out
filelist_diff 7

kill -INT $pid
wait

pkg_clean 8
