#!/bin/sh -eu
#
# ░█▀▀░░░▀█▀░▀█▀░░░█▀▄░█░█░█▀█
# ░█░░░░░░█░░░█░░░░█▀▄░█░█░█░█
# ░▀▀▀░░░▀▀▀░░▀░░░░▀░▀░▀▀▀░▀░▀
#
# Creates Jamrules.
#
type pkg-config
type llvm-config

# stuff still not accounted for:
# - C++11 capable compiler
# - Curses
# - DejaVu Sans Mono
# - Jam
# - LLVM and Clang > 3.7
# - OpenGLES >= 2.0

gl_pkgs="osmesa glfw3 glew freetype2"

should_exit=0
for pkg in $gl_pkgs; do
	if ! pkg-config --exists $pkg; then
		echo "$pkg not found"
		should_exit=1
	fi
done
test $should_exit -eq 0 || exit 1

cat <<EOF > Jamrules
#
# Generated by './configure' on `date`
#
echo ...build C It Run on \$(OS)... ;

CC = ${CC-cc} ;
C++ = ${CXX-c++} ;

CCFLAGS += "${CFLAGS-}" ;
C++FLAGS += -std=c++11 -fno-exceptions -fno-rtti ${CFLAGS-} ;
LINKFLAGS += "${LDFLAGS-}" ;

CITRUN_SRCDIR = "`pwd`/src" ;

GL_CFLAGS = "`pkg-config --cflags glfw3 glew freetype2`" ;
GL_LIBS = "`pkg-config --libs glfw3 glew freetype2`" ;
GLTEST_LIBS  = "`pkg-config --libs osmesa`" ;

INST_CFLAGS = "`llvm-config --cxxflags`" ;
INST_LDFLAGS = "`llvm-config --ldflags`" ;
INST_LIBS = "`llvm-config --libs bitreader mcparser transformutils option`" ;
INST_LIBS += "`llvm-config --system-libs`" ;

if \$(OS) = OPENBSD {
	LDGROUP_START = -Wl,--start-group ;
	LDGROUP_END = -Wl,--end-group ;
}

if \$(OS) = MACOSX {
	LINKLIBS on citrun-gl = -framework OpenGL ;
}

if \$(OS) = LINUX {
	LINKLIBS on citrun-gl citrun-inst = -lbsd ;
	LDGROUP_START = -Wl,--start-group ;
	LDGROUP_END = -Wl,--end-group ;
}
EOF

echo "...call \`jam\` to build..."
