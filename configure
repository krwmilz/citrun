#!/bin/sh -eu
#
# Checks that a bunch of crap is installed, creates Jamrules file.
#
echo ░█▀▀░░░▀█▀░▀█▀░░░█▀▄░█░█░█▀█
echo ░█░░░░░░█░░░█░░░░█▀▄░█░█░█░█
echo ░▀▀▀░░░▀▀▀░░▀░░░░▀░▀░▀▀▀░▀░▀
echo Configuring...
echo

# These binaries are assumed throughout so make sure they are available.
type pkg-config
type llvm-config
type jam
echo

# Operating system specific variables.
uname=`uname`
if [ $uname = OpenBSD ]; then
	LDGROUP_START="-Wl,--start-group"
	LDGROUP_END="-Wl,--end-group"
	FONT_PATH="/usr/X11R6/lib/X11/fonts/TTF/DejaVuSansMono.ttf"
	CXX=${CXX-eg++}
elif [ $uname = Darwin ]; then
	GL_EXTRALIB="-framework OpenGL"
	FONT_PATH="/Library/Fonts/Andale Mono.ttf"
elif [ $uname = Linux ]; then
	GL_EXTRALIB="-lbsd"
	INST_EXTRALIB="-lbsd"
	LDGROUP_START="-Wl,--start-group"
	LDGROUP_END="-Wl,--end-group"
	FONT_PATH="/usr/share/fonts/truetype/dejavu/DejaVuSansMono.ttf"
else
	echo WARNING: Platform $uname not tested. Compilation may fail.
	echo
fi

# C++11 required.
${CXX-c++} -x c++ -std=c++11 -E - < /dev/null > /dev/null

# citrun_gltest needs osmesa and both it and citrun_gl need the rest.
gl_pkgs="osmesa glfw3 glew freetype2"
for pkg in $gl_pkgs; do
	printf "%10s = " $pkg
	pkg-config --modversion $pkg || (echo "not found" && exit 1)
done
echo

# citrun_inst needs clang and llvm libraries.
CLANG_LIBS="-lclangAST -lclangAnalysis -lclangBasic -lclangDriver \
	-lclangEdit -lclangFrontend -lclangFrontendTool -lclangLex \
	-lclangParse -lclangRewrite -lclangRewriteFrontend -lclangSema \
	-lclangSerialization -lclangTooling"

LLVM_LIBS="bitreader mcparser transformutils option"

# Write top of Jamrules. Any errors inside backticks get ignored.
cat <<EOF > Jamrules
CC = ${CC-cc} ;
C++ = ${CXX-c++} ;

CCFLAGS += ${CFLAGS-} ;
C++FLAGS += -std=c++11 -fno-exceptions -fno-rtti ${CFLAGS-} ;
LINKFLAGS += ${LDFLAGS-} ;

FONT_PATH = "${FONT_PATH}" ;

GL_CFLAGS = `pkg-config --cflags glfw3 glew freetype2` ;
GL_LIBS = ${GL_EXTRALIB-} `pkg-config --libs glfw3 glew freetype2` ;
GLTEST_LIBS  = `pkg-config --libs osmesa` ;

INST_CFLAGS = `llvm-config --cxxflags` ;
INST_LDFLAGS = `llvm-config --ldflags` ;
INST_LIBS = ${INST_EXTRALIB-}
	${LDGROUP_START-} ${CLANG_LIBS} ${LDGROUP_END-}
	`llvm-config --libs ${LLVM_LIBS}`
	`llvm-config --system-libs` ;
EOF
