#!/bin/sh -eu
#
# Checks that a bunch of crap is installed, creates Jamrules file.
#
uname=`uname`
echo ░█▀▀░░░▀█▀░▀█▀░░░█▀▄░█░█░█▀█
echo ░█░░░░░░█░░░█░░░░█▀▄░█░█░█░█
echo ░▀▀▀░░░▀▀▀░░▀░░░░▀░▀░▀▀▀░▀░▀
echo C It Run 0.0 on $uname
echo

# These binaries are assumed throughout so make sure they are available.
type pkg-config
type llvm-config
type jam
echo

# C++11 required.
${CXX-c++} -x c++ -std=c++11 -E - < /dev/null > /dev/null

# citrun-gltest needs osmesa and both it and citrun-gl need the rest.
gl_pkgs="osmesa glfw3 glew freetype2"
for pkg in $gl_pkgs; do
	printf "%10s = " $pkg
	pkg-config --modversion $pkg || (echo "not found" && exit 1)
done
echo

if [ $uname = OpenBSD ]; then
	LDGROUP_START="-Wl,--start-group"
	LDGROUP_END="-Wl,--end-group"
	FONT_PATH="/usr/X11R6/lib/X11/fonts/TTF/DejaVuSansMono.ttf"
elif [ $uname = Darwin ]; then
	GL_EXTRALIB="-framework OpenGL"
	FONT_PATH="/Library/Fonts/Andale Mono.ttf"
elif [ $uname = Linux ]; then
	GL_EXTRALIB="-lbsd"
	INST_EXTRALIB="-lbsd"
	LDGROUP_START="-Wl,--start-group"
	LDGROUP_END="-Wl,--end-group"
	FONT_PATH="/usr/share/fonts/truetype/dejavu/DejaVuSansMono.ttf"
else
	echo WARNING: Platform $uname not tested. Compilation may fail.
	echo
fi

# Write top of Jamrules. Note any errors inside backticks will be ignored.
cat <<EOF > Jamrules
CC = ${CC-cc} ;
C++ = ${CXX-c++} ;

CCFLAGS += "${CFLAGS-}" ;
C++FLAGS += -std=c++11 -fno-exceptions -fno-rtti ${CFLAGS-} ;
LINKFLAGS += "${LDFLAGS-}" ;

FONT_PATH = "${FONT_PATH}" ;
CITRUN_SRCDIR = "`pwd`/src" ;

GL_CFLAGS = "`pkg-config --cflags glfw3 glew freetype2`" ;
GL_LIBS = "${GL_EXTRALIB-} `pkg-config --libs glfw3 glew freetype2`" ;
GLTEST_LIBS  = "`pkg-config --libs osmesa`" ;

INST_CFLAGS = "`llvm-config --cxxflags`" ;
INST_LDFLAGS = "`llvm-config --ldflags`" ;
INST_LIBS = "${INST_EXTRALIB-} ${LDGROUP_START-} -lclangAST -lclangAnalysis \
-lclangBasic -lclangDriver \
-lclangEdit -lclangFrontend -lclangFrontendTool -lclangLex -lclangParse \
-lclangRewrite -lclangRewriteFrontend -lclangSema -lclangSerialization \
-lclangTooling ${LDGROUP_END-} \
`llvm-config --libs bitreader mcparser transformutils option` \
`llvm-config --system-libs`" ;
EOF
echo === Configuration Summary ===================================================
cat Jamrules
echo =============================================================================

cat Jamrules.tail >> Jamrules
