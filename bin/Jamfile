SubDir TOP bin ;
SubDirHdrs $(TOP) lib ;

actions ShellReplace {
	sed -e "s, PREFIX ,$(PREFIX)," < $(>) > $(<)
	chmod +x $(<)
}

#
# citrun_check
#
SHELLHEADER = "#!/usr/bin/awk -f" ;
MakeLocate citrun_check : bin ;
Shell citrun_check : check.awk ;

#
# citrun_wrap
#
MakeLocate citrun_wrap : bin ;
Depends all : citrun_wrap ;
Clean clean : citrun_wrap ;
ShellReplace citrun_wrap : wrap.sh ;

#
# citrun_inst
#
INST_SRCS =
	inst_main.cc
	inst_fe.cc
	inst_feunix.cc
	inst_action.cc
	inst_visitor.cc ;

Stringize lib_h.h : lib.h ;

ObjectC++Flags $(INST_SRCS) : $(INST_CFLAGS) -DPREFIX=\\\"$(PREFIX)\\\" ;

LINKFLAGS on citrun_inst = $(LINKFLAGS) $(INST_LDFLAGS) ;
LINKLIBS on citrun_inst += $(INST_LIBS) ;

Main citrun_inst : $(INST_SRCS) ;

#
# citrun_gl,  citrun_gltest
#
GL_SRCS =
	gl_procfile.cc
	gl_transunit.cc
	process_dir.cc
	gl_view.cc
	demo-atlas.cc
	gl_buffer.cc
	gl_font.cc
	demo-glstate.cc
	demo-shader.cc
	matrix4x4.c ;

Library gl_common : $(GL_SRCS) ;

Stringize demo_atlas_glsl.h :   demo_atlas.glsl ;
Stringize demo_vshader_glsl.h : demo_vshader.glsl ;
Stringize demo_fshader_glsl.h : demo_fshader.glsl ;

ObjectC++Flags gl_main.cc gltest.cc $(GL_SRCS) : $(GL_CFLAGS) ;

LINKLIBS on citrun_gl citrun_gltest += -lm $(GL_LIBS) ;
LinkLibraries citrun_gl citrun_gltest : gl_common libglyphy ;

Main citrun_gl : gl_main.cc ;

LINKLIBS on citrun_gltest += $(GLTEST_LIBS) ;
Main citrun_gltest : gltest.cc ;

# Link with the c++ compiler so that the matching c++ runtime library gets added
# automatically.
LINK on citrun_inst citrun_gl citrun_gltest = $(C++) ;

#
# install
#
InstallShell	$(PREFIX)/bin		: citrun_check citrun_wrap ;
InstallBin	$(PREFIX)/bin		: citrun_gl citrun_inst ;

SubInclude TOP bin glyphy ;
